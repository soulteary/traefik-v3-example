# OwlMail 邮件测试服务示例配置
# https://github.com/soulteary/owlmail
#
# 使用说明：
# 1. 修改环境变量中的域名配置（OWLMAIL_DOMAIN）
# 2. 确保域名 DNS 解析正确
# 3. 启动服务：docker-compose -f docker-compose.owlmail.yml up -d
#
# 访问示例：
# - OwlMail Web 界面: https://mail.example.com
# - SMTP 服务器: localhost:1025 (用于应用程序发送测试邮件)
#
# 配置说明：
# - Web 界面通过 Traefik 暴露，支持 HTTPS
# - SMTP 端口 1025 直接暴露，供应用程序连接
# - 邮件数据持久化存储在 ./owlmail-data 目录

name: owlmail

services:
  # OwlMail 邮件测试服务
  owlmail:
    image: ghcr.io/soulteary/owlmail:latest
    container_name: owlmail
    restart: always
    ports:
      # 暴露 SMTP 端口，供应用程序连接发送测试邮件
      - "1025:1025"
    environment:
      # SMTP 服务器配置
      - MAILDEV_SMTP_PORT=1025
      - MAILDEV_SMTP_HOST=0.0.0.0
      # Web 界面配置（容器内部端口，通过 Traefik 暴露）
      - MAILDEV_WEB_PORT=1080
      - MAILDEV_WEB_IP=0.0.0.0
      # 邮件存储目录（可选，持久化邮件数据）
      # - MAILDEV_MAIL_DIRECTORY=/data/mails
      # HTTP Basic Auth（可选，保护 Web 界面）
      # - MAILDEV_WEB_USER=admin
      # - MAILDEV_WEB_PASS=password123
      # 日志级别（可选：normal, verbose, silent）
      # - MAILDEV_VERBOSE=false
    volumes:
      # 邮件数据持久化（可选）
      - ./owlmail-data:/data/mails
    networks:
      - traefik
    labels:
      # 启用 Traefik 服务发现
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP 路由 - 重定向到 HTTPS
      - "traefik.http.routers.owlmail-http.entrypoints=http"
      - "traefik.http.routers.owlmail-http.middlewares=redir-https"
      - "traefik.http.routers.owlmail-http.rule=Host(`mail.example.com`)"
      - "traefik.http.routers.owlmail-http.service=noop@internal"

      # HTTPS 路由 - OwlMail Web 界面
      - "traefik.http.routers.owlmail-https.entrypoints=https"
      - "traefik.http.routers.owlmail-https.tls=true"
      - "traefik.http.routers.owlmail-https.middlewares=gzip"
      - "traefik.http.routers.owlmail-https.rule=Host(`mail.example.com`)"
      
      # 服务配置
      - "traefik.http.services.owlmail-backend.loadbalancer.server.scheme=http"
      - "traefik.http.services.owlmail-backend.loadbalancer.server.port=1080"

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:1080/healthz || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  traefik:
    external: true
